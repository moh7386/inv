<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام فواتير ARC تيك</title>
    <style>
        :root {
            --primary-color: #1A6D69; --secondary-color: #155A56; --light-gray: #f4f6f6;
            --medium-gray: #e9ecef; --dark-gray: #333333; --border-color: #dce3e2;
            --white: #ffffff; --text-color: #4a4a4a;
        }
        body { font-family: 'Tahoma','Arial',sans-serif; margin:0; padding:10px; /* Reduced padding for mobile */ background-color:var(--medium-gray); color:var(--text-color); direction:rtl; font-size:14px; /* Base font for mobile */ -webkit-text-size-adjust: 100%; /* Prevent iOS font scaling */ }
        .container { display:flex; flex-direction:column; gap:20px; max-width:900px; margin:auto; }
        .invoice-form { background-color:var(--white); padding:15px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
        .invoice-form h2, .invoice-form h3 { color:var(--primary-color); border-bottom:1px solid var(--border-color); padding-bottom:8px; margin-top:0; margin-bottom:12px; }
        .invoice-form h2 { font-size:1.3em; } /* Adjusted for mobile */
        .invoice-form h3 { font-size:1.1em; margin-top:15px; } /* Adjusted for mobile */
        .form-group { margin-bottom:10px; }
        .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px 8px; border:1px solid var(--border-color); border-radius:4px; font-size:0.9em; box-sizing:border-box; background-color:#fdfdfd; }
        .form-group textarea { min-height:60px; }
        .form-group ::placeholder { color:#888; opacity:1; font-size:0.9em; }
        .company-data-actions button, .saved-invoices-section button { padding:8px 10px; font-size:0.8em; margin-left:5px;}
        .saved-invoices-section select { margin-bottom: 5px; }

        .item-row { display:flex; flex-wrap: wrap; /* Allow wrapping on small screens */ gap:5px; margin-bottom:8px; align-items:center; }
        .item-row input.item-desc { flex-basis: 100%; margin-bottom: 5px; /* Full width on its own line */ }
        .item-row input.item-qty { width:60px !important; flex-grow:1; text-align:center; }
        .item-row input.item-price { width:80px !important; flex-grow:1; text-align:center; }
        .item-row button.remove-item-btn { padding:8px 10px; font-size:0.85em; flex-shrink: 0; /* Prevent shrinking */ }
        #addItemBtn { padding:9px 12px; font-size:0.95em; display: block; width: 100%; margin-top:10px; }

        .invoice-preview-container { background-color:var(--white); box-shadow:0 3px 10px rgba(0,0,0,0.1); width:100%; max-width:794px; margin:0 auto; padding:0; border:1px solid #ccc; }
        .invoice-preview { padding:20px 15px; /* Reduced padding for mobile */ }
        .invoice-preview-header { display:flex; flex-direction: column-reverse; /* Stack company above invoice details on mobile */ align-items:center; /* Center align header items */ text-align:center; padding-bottom:15px; border-bottom:2px solid var(--primary-color); margin-bottom:15px; }
        .header-left, .header-right { flex-basis:auto; width:100%; } /* Full width for stacked items */
        .header-right { margin-bottom:15px; }
        .header-right img#previewLogo { max-width:150px; max-height:75px; margin:0 auto 10px auto; display:block; } /* Adjusted logo size and centering */
        .header-left h1 { font-size:1.8em; padding:8px 12px; margin-bottom:10px; display:block; }
        .header-left .invoice-meta p { font-size:0.8em; }
        .header-left .invoice-meta strong { display:inline-block; min-width:auto; margin-left:5px; }
        .header-left .bill-to { margin-top:10px; font-size:0.85em;}

        .invoice-items-wrapper { overflow-x:auto; margin-bottom: 15px;}
        .items-table-visual { width:100%; min-width: 550px; /* Ensure table scrolls if content is wide */ border-collapse:collapse; font-size:0.8em; }
        .items-table-visual th, .items-table-visual td { padding:6px 8px; }
        /* ... (rest of table styles as before) ... */
        .items-table-visual th.col-no, .items-table-visual td.col-no {width: 5%;}
        .items-table-visual th.col-desc, .items-table-visual td.col-desc {width: auto; text-align: right;} /* auto for flexibility */
        .items-table-visual th.col-price, .items-table-visual td.col-price {width: 20%;}
        .items-table-visual th.col-qty, .items-table-visual td.col-qty {width: 15%;}
        .items-table-visual th.col-total, .items-table-visual td.col-total {width: 20%;}
        .items-table-visual tbody tr:nth-child(even) td { background-color:var(--light-gray); }


        .invoice-summary-and-terms { display:flex; flex-direction:column; /* Stack on mobile */ margin-bottom:15px; font-size:0.85em; }
        .summary-section { width:100%; text-align:left; margin-bottom:15px; }
        .summary-section table { width:100%; max-width: 320px; /* Limit width on mobile */ margin: 0 auto 10px auto; /* Center summary table */ }
        .summary-section td:first-child { width: auto; padding-left: 5px; } /* Allow label to take needed space */
        .summary-section td:last-child { padding-left: 5px; }
        .summary-section .grand-total-row td { font-size:1em; padding:7px 8px; }
        .summary-section .signature-area { margin-top:20px; width:70%; margin-left:auto; margin-right:auto; }
        .terms-section { width:100%; text-align:center; padding-right:0; } /* Center terms on mobile */
        .terms-section h4 { font-size:0.9em; }
        .terms-section p { font-size:0.8em; }

        .invoice-preview-footer { padding:8px 0; font-size:0.75em; }
        .invoice-preview-footer span { display:block; margin: 3px auto; text-align:center; } /* Stack footer items */

        .actions-buttons-container { padding:10px; margin-top:15px; }
        .actions-buttons-container button { padding:10px 15px; font-size:0.9em; display:block; width:100%; margin:8px 0; }


        /* Larger screens - Tablet and Desktop */
        @media (min-width: 768px) {
            body { padding: 20px; font-size: 15px; }
            .invoice-form { padding: 20px; }
            .invoice-form h2 { font-size:1.5em; }
            .invoice-form h3 { font-size:1.15em; }
            .item-row input.item-desc { flex-basis:auto; margin-bottom: 0; } /* Reset for larger screens */
            .item-row { flex-wrap: nowrap; }
            #addItemBtn { display: inline-block; width: auto; }

            .invoice-preview { padding:30px 35px; }
            .invoice-preview-header { flex-direction:row; align-items:flex-start; text-align:inherit; }
            .header-left { text-align:left; }
            .header-right { text-align:right; }
            .header-right img#previewLogo { max-width:200px; max-height:100px; margin-left:auto; margin-right:0; }
            .header-left h1 { display:inline-block; }
            .header-left .invoice-meta p, .header-left .bill-to { text-align:left; }
            .header-left .invoice-meta strong { min-width:90px; }

            .items-table-visual { min-width: auto; font-size:0.9em; }
            .items-table-visual th, .items-table-visual td { padding:8px 10px; }

            .invoice-summary-and-terms { flex-direction:row; font-size:0.9em; }
            .summary-section { text-align:left; width:45%; }
            .summary-section table { margin: 0 0 15px 0; max-width:none; }
            .summary-section .signature-area { margin-left:0; }
            .terms-section { text-align:right; width:50%; padding-right:20px; }
            .terms-section h4, .terms-section p {text-align: right;}


            .invoice-preview-footer span { display:inline-block; margin: 0 10px; }
            .actions-buttons-container button { display:inline-block; width:auto; margin:5px; }
        }

        @media print {
            body { background-color:var(--white) !important; padding:0; margin:0; font-size:9pt; -webkit-print-color-adjust:exact !important; color-adjust:exact !important; }
            .container, .invoice-form, .actions-buttons-container { display:none !important; }
            .invoice-preview-container { display:block !important; width:100% !important; max-width:none !important; margin:0 !important; padding:0 !important; box-shadow:none !important; border:none !important; }
            .invoice-preview { padding:15mm !important; /* A4-like margins */ page-break-after:always; }
            .invoice-preview-header { flex-direction:row !important; align-items:flex-start !important; text-align:inherit !important; } /* Restore desktop header */
            .invoice-items-wrapper { overflow-x:visible !important; }
            .items-table-visual { min-width:unset !important; font-size: 8.5pt !important; } /* Adjust table font for print */
            .items-table-visual th, .items-table-visual td { padding: 5px 7px !important; }
            .invoice-summary-and-terms { flex-direction:row !important; } /* Restore desktop summary */
        }
    </style>
</head>
<body>
    <!-- ... (نفس محتوى HTML من الإجابة السابقة) ... -->
    <div class="container">
        <div class="invoice-form">
            <h2>إعدادات فاتورة ARC تيك</h2>

            <div class="saved-invoices-section form-group">
                <h3>الفواتير المحفوظة</h3>
                <select id="savedInvoicesList" onchange="loadSelectedInvoice()">
                    <option value="">-- اختر فاتورة للتعديل --</option>
                </select>
                <button type="button" class="delete-btn" onclick="deleteSelectedInvoice()">حذف المختارة</button>
                <button type="button" onclick="clearInvoiceFormAndPreview()" style="margin-right: 5px;">فاتورة جديدة</button>
            </div>
            <hr>

            <div class="form-group">
                <select id="currency" onchange="updateAllPreviews()">
                    <option value="USD" data-symbol="$" selected>دولار أمريكي ($)</option>
                    <option value="SAR" data-symbol="ر.س">ريال سعودي (ر.س)</option>
                    <option value="YER" data-symbol="ر.ي">ريال يمني (ر.ي)</option>
                </select>
            </div>

            <h3>
                معلومات شركتك
                <span class="company-data-actions">
                    <button type="button" onclick="saveCompanyData()">حفظ بيانات الشركة</button>
                    <button type="button" onclick="loadCompanyData()">استرجاع بيانات الشركة</button>
                </span>
            </h3>
            <div class="form-group"><input type="file" id="companyLogo" accept="image/*" onchange="previewLogoImage(event)"></div>
            <div class="form-group"><input type="text" id="brandName" placeholder="اسم الشركة" onkeyup="updatePreview('brandName', 'previewBrandName')"></div>
            <div class="form-group"><input type="text" id="tagline" placeholder="وصف الشركة (اختياري)" onkeyup="updatePreview('tagline', 'previewTagline')"></div>
            <div class="form-group"><input type="text" id="companyPaymentInfo1" placeholder="معلومة دفع 1 (مثال: Account)" onkeyup="updatePreview('companyPaymentInfo1', 'previewCompanyPaymentInfo1')"></div>
            <div class="form-group"><input type="text" id="companyPaymentInfo2" placeholder="معلومة دفع 2 (مثال: A/c Name)" onkeyup="updatePreview('companyPaymentInfo2', 'previewCompanyPaymentInfo2')"></div>
            <div class="form-group"><input type="text" id="companyFooterText" placeholder="نص الفوتر (مثال: بريد، هاتف، موقع)" onkeyup="updatePreview('companyFooterText', 'previewCompanyFooterText')"></div>

            <h3>تفاصيل الفاتورة</h3>
            <div class="form-group"><input type="text" id="invoiceNumber" placeholder="رقم الفاتورة" onkeyup="updatePreview('invoiceNumber', 'previewInvoiceNumber')"></div>
            <div class="form-group"><input type="date" id="invoiceDate" placeholder="تاريخ الفاتورة" onchange="updatePreviewDate('invoiceDate', 'previewInvoiceDate')"></div>
            <div class="form-group"><input type="date" id="dueDate" placeholder="تاريخ الاستحقاق" onchange="updatePreviewDate('dueDate', 'previewDueDate')"></div>
            <div class="form-group"><input type="text" id="accountNumber" placeholder="رقم حساب العميل (إن وجد)" onkeyup="updatePreview('accountNumber', 'previewAccountNumber')"></div>

            <h3>فاتورة إلى (Bill To)</h3>
            <div class="form-group"><input type="text" id="clientName" placeholder="اسم العميل/الشركة" onkeyup="updatePreview('clientName', 'previewClientName')"></div>
            <div class="form-group"><textarea id="clientAddress" placeholder="عنوان العميل" onkeyup="updatePreview('clientAddress', 'previewClientAddress', true)"></textarea></div>

            <h3>بنود الفاتورة</h3>
            <div id="invoiceItemsContainer"></div>
            <button type="button" id="addItemBtn" onclick="addInvoiceItem()">إضافة بند +</button>

            <h3>الملخص</h3>
            <div class="form-group"><input type="number" id="discountRate" placeholder="نسبة الخصم (%)" value="0" min="0" max="100" step="0.01" oninput="calculateTotals()"></div>

            <h3>نصوص إضافية</h3>
            <div class="form-group"><textarea id="termsConditions" placeholder="الشروط والأحكام" onkeyup="updatePreview('termsConditions', 'previewTermsConditions', true)">شكراً لتعاملكم معنا.</textarea></div>
        </div>

        <div class="invoice-preview-container">
            <div class="invoice-preview" id="invoiceToPrint">
                <header class="invoice-preview-header">
                    <div class="header-left">
                        <h1>INVOICE</h1>
                        <div class="invoice-meta">
                            <p><strong>Invoice No:</strong> <span id="previewInvoiceNumber"></span></p>
                            <p><strong>Date:</strong> <span id="previewInvoiceDate"></span></p>
                            <p><strong>Due Date:</strong> <span id="previewDueDate"></span></p>
                            <p><strong>Account No:</strong> <span id="previewAccountNumber"></span></p>
                        </div>
                        <div class="bill-to">
                            <strong>BILL TO.</strong>
                            <span id="previewClientName"></span>
                            <span id="previewClientAddress"></span>
                        </div>
                    </div>
                    <div class="header-right">
                        <img src="https://via.placeholder.com/200x100.png?text=ARC+Tech+Logo" alt="شعار الشركة" id="previewLogo">
                        <div id="previewBrandName">ARC تيك</div>
                        <div id="previewTagline">حلول تقنية متكاملة</div>
                        <div class="payment-info-basic">
                            <p><strong>Account:</strong> <span id="previewCompanyPaymentInfo1"></span></p>
                            <p><strong>A/c Name:</strong> <span id="previewCompanyPaymentInfo2"></span></p>
                        </div>
                    </div>
                </header>
                <div class="invoice-items-wrapper">
                    <table class="items-table-visual">
                        <thead>
                            <tr><th class="col-no">NO</th><th class="col-desc">PRODUCT DESCRIPTION</th><th class="col-price">UNIT PRICE</th><th class="col-qty">QTY</th><th class="col-total">TOTAL</th></tr>
                        </thead>
                        <tbody id="previewItemsTableBody"></tbody>
                    </table>
                </div>
                <section class="invoice-summary-and-terms">
                    <div class="summary-section">
                        <table>
                            <tr><td>المجموع الفرعي</td><td><span id="previewSubtotal"></span></td></tr>
                            <tr id="previewDiscountRow" style="display:none;"><td>الخصم (<span id="previewDiscountRate">0</span>%)</td><td><span id="previewDiscountAmount"></span></td></tr>
                            <tr class="grand-total-row"><td>الإجمالي الكلي</td><td><span id="previewGrandTotal"></span></td></tr>
                        </table>
                        <div class="signature-area">التوقيع</div>
                    </div>
                    <div class="terms-section">
                        <h4>الشروط والأحكام</h4>
                        <p id="previewTermsConditions"></p>
                    </div>
                </section>
                <footer class="invoice-preview-footer"><span id="previewCompanyFooterText"></span></footer>
            </div>
        </div>
        <div class="actions-buttons-container">
            <button onclick="saveCurrentInvoice()">حفظ/تحديث الفاتورة</button>
            <button onclick="window.print()">طباعة الفاتورة</button>
            <button class="pdf-btn" onclick="downloadPDF()">تنزيل كـ PDF</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // --- JavaScript (نفس الكود من الإجابة السابقة) ---
        // ... (انسخ والصق كامل كود JavaScript من الإجابة السابقة هنا) ...
        // يتضمن: itemCounter, currentCurrencySymbol, companyDataKey, savedInvoicesKey, companyFields
        // والدوال: el, getCurrentDate, getCurrentDisplayDate, updatePreview, updatePreviewDate,
        // previewLogoImage, addInvoiceItem, removeInvoiceItem, formatCurrency, calculateTotals,
        // updateAllPreviews, saveCompanyData, loadCompanyData, saveCurrentInvoice,
        // populateSavedInvoicesList, loadSelectedInvoice, deleteSelectedInvoice,
        // clearInvoiceFormAndPreview, downloadPDF (المعدلة), و event listener لـ DOMContentLoaded
        let itemCounter = 0;
        let currentCurrencySymbol = '$';
        const companyDataKey = 'arcTechCompanyData_v1';
        const savedInvoicesKey = 'arcTechSavedInvoices_v1';
        const companyFields = ['brandName', 'tagline', 'companyPaymentInfo1', 'companyPaymentInfo2', 'companyFooterText'];

        function el(id) { return document.getElementById(id); }

        function getCurrentDate() { const n = new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`; }
        function getCurrentDisplayDate() { const n = new Date(); return `${String(n.getDate()).padStart(2,'0')}/${String(n.getMonth()+1).padStart(2,'0')}/${n.getFullYear()}`; }

        function updatePreview(inputId, previewId, isTextarea = false) {
            const input = el(inputId); const preview = el(previewId);
            if (input && preview) preview[isTextarea ? 'innerText' : 'textContent'] = input.value;
        }

        function updatePreviewDate(inputId, previewId) {
            const input = el(inputId); const preview = el(previewId);
            if (input && preview) {
                const dateVal = input.value;
                if (dateVal) { const [y,m,d] = dateVal.split('-'); preview.textContent = `${d}/${m}/${y}`; }
                else { preview.textContent = (inputId === 'invoiceDate') ? getCurrentDisplayDate() : ''; }
            }
        }

        function previewLogoImage(event) {
            const reader = new FileReader(); const output = el('previewLogo'); if (!output) return;
            reader.onload = function(){ output.src = reader.result; };
            if (event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
            else output.src = 'https://via.placeholder.com/200x100.png?text=ARC+Tech+Logo';
        }

        function addInvoiceItem(description = '', quantity = 1, price = 0.00) {
            itemCounter++;
            const container = el('invoiceItemsContainer'); if (!container) return;
            const row = document.createElement('div'); row.className = 'item-row'; row.id = `item-row-${itemCounter}`;
            row.innerHTML = `
                <input type="text" class="item-desc" placeholder="وصف البند" value="${description}" oninput="calculateTotals()">
                <input type="number" class="item-qty" value="${quantity}" min="0" placeholder="الكمية" oninput="calculateTotals()">
                <input type="number" class="item-price" value="${parseFloat(price).toFixed(2)}" step="0.01" placeholder="السعر" oninput="calculateTotals()">
                <button type="button" class="remove-item-btn" onclick="removeInvoiceItem('item-row-${itemCounter}')">X</button>`;
            container.appendChild(row);
            calculateTotals();
        }

        function removeInvoiceItem(rowId) { const row = el(rowId); if (row) row.remove(); calculateTotals(); }
        function formatCurrency(amount) { return `${currentCurrencySymbol} ${parseFloat(amount).toFixed(2)}`; }

        function calculateTotals() {
            const itemsCont = el('invoiceItemsContainer'); const tableBody = el('previewItemsTableBody');
            if (!itemsCont || !tableBody) return;
            tableBody.innerHTML = ''; let subtotal = 0; let num = 0;

            Array.from(itemsCont.children).forEach(r => {
                if (!r.classList.contains('item-row')) return; num++;
                const desc = r.querySelector('.item-desc').value;
                const qty = parseFloat(r.querySelector('.item-qty').value) || 0;
                const price = parseFloat(r.querySelector('.item-price').value) || 0;
                const total = qty * price; subtotal += total;
                const pR = tableBody.insertRow();
                pR.insertCell().outerHTML=`<td class="col-no">${String(num).padStart(2,'0')}</td>`;
                pR.insertCell().outerHTML=`<td class="col-desc">${desc}</td>`;
                pR.insertCell().outerHTML=`<td class="col-price">${formatCurrency(price)}</td>`;
                pR.insertCell().outerHTML=`<td class="col-qty">${qty}</td>`;
                pR.insertCell().outerHTML=`<td class="col-total">${formatCurrency(total)}</td>`;
            });

            const discInput = el('discountRate'); const discPerc = discInput ? parseFloat(discInput.value) || 0 : 0;
            const discAmount = (subtotal * discPerc) / 100;
            const grandTotal = subtotal - discAmount;

            if(el('previewSubtotal')) el('previewSubtotal').textContent = formatCurrency(subtotal);
            if(el('previewDiscountRate')) el('previewDiscountRate').textContent = discPerc;
            if(el('previewDiscountAmount')) el('previewDiscountAmount').textContent = formatCurrency(discAmount);
            if(el('previewGrandTotal')) el('previewGrandTotal').textContent = formatCurrency(grandTotal);
            const discRow = el('previewDiscountRow'); if(discRow) discRow.style.display = discPerc > 0 ? 'table-row' : 'none';
        }

        function updateAllPreviews() {
            const currSelect = el('currency'); if (currSelect) currentCurrencySymbol = currSelect.options[currSelect.selectedIndex].dataset.symbol;
            companyFields.forEach(id => updatePreview(id, `preview${id.charAt(0).toUpperCase() + id.slice(1)}`));
            updatePreview('invoiceNumber', 'previewInvoiceNumber'); updatePreviewDate('invoiceDate', 'previewInvoiceDate');
            updatePreviewDate('dueDate', 'previewDueDate'); updatePreview('accountNumber', 'previewAccountNumber');
            updatePreview('clientName', 'previewClientName'); updatePreview('clientAddress', 'previewClientAddress', true);
            updatePreview('termsConditions', 'previewTermsConditions', true);
            calculateTotals();
        }

        function saveCompanyData() {
            const data = {}; companyFields.forEach(id => { const input = el(id); if (input) data[id] = input.value; });
            const logo = el('previewLogo');
            if (logo && logo.src && !logo.src.includes('via.placeholder.com')) data.companyLogoSrc = logo.src; else data.companyLogoSrc = '';
            localStorage.setItem(companyDataKey, JSON.stringify(data)); alert('تم حفظ بيانات الشركة!');
        }

        function loadCompanyData() {
            const saved = localStorage.getItem(companyDataKey);
            if (saved) {
                const data = JSON.parse(saved);
                companyFields.forEach(id => { const input = el(id); if (input && data[id] !== undefined) input.value = data[id]; });
                const logo = el('previewLogo');
                if (logo && data.companyLogoSrc) logo.src = data.companyLogoSrc;
                else if (logo) logo.src = 'https://via.placeholder.com/200x100.png?text=ARC+Tech+Logo';
            }
        }

        function saveCurrentInvoice() {
            const invNum = el('invoiceNumber').value.trim(); if (!invNum) { alert('يرجى إدخال رقم الفاتورة.'); return; }
            const invData = {
                invoiceNumber: invNum, invoiceDate: el('invoiceDate').value, dueDate: el('dueDate').value,
                accountNumber: el('accountNumber').value, clientName: el('clientName').value, clientAddress: el('clientAddress').value,
                discountRate: el('discountRate').value, termsConditions: el('termsConditions').value,
                companyDetails: {}, items: []
            };
            companyFields.forEach(id => { const input = el(id); if (input) invData.companyDetails[id] = input.value; });
            const logo = el('previewLogo');
            if (logo && logo.src && !logo.src.includes('via.placeholder.com')) invData.companyDetails.companyLogoSrc = logo.src;
            else invData.companyDetails.companyLogoSrc = '';

            const itemsCont = el('invoiceItemsContainer');
            Array.from(itemsCont.children).forEach(r => {
                if (r.classList.contains('item-row')) {
                    invData.items.push({
                        description: r.querySelector('.item-desc').value,
                        quantity: r.querySelector('.item-qty').value,
                        price: r.querySelector('.item-price').value
                    });
                }
            });

            let invoices = JSON.parse(localStorage.getItem(savedInvoicesKey)) || [];
            const idx = invoices.findIndex(i => i.invoiceNumber === invNum);
            if (idx > -1) invoices[idx] = invData; else invoices.push(invData);
            localStorage.setItem(savedInvoicesKey, JSON.stringify(invoices));
            alert(idx > -1 ? 'تم تحديث الفاتورة!' : 'تم حفظ الفاتورة!');
            populateSavedInvoicesList();
        }

        function populateSavedInvoicesList() {
            const select = el('savedInvoicesList'); select.innerHTML = '<option value="">-- اختر فاتورة للتعديل --</option>';
            const invoices = JSON.parse(localStorage.getItem(savedInvoicesKey)) || [];
            invoices.sort((a, b) => (a.invoiceNumber > b.invoiceNumber) ? 1 : -1);
            invoices.forEach(inv => {
                const opt = document.createElement('option');
                opt.value = inv.invoiceNumber;
                opt.textContent = `فاتورة: ${inv.invoiceNumber} (عميل: ${inv.clientName || 'N/A'})`;
                select.appendChild(opt);
            });
        }

        function loadSelectedInvoice() {
            const select = el('savedInvoicesList'); const invNum = select.value;
            if (!invNum) { clearInvoiceFormAndPreview(false); return; }
            const invoices = JSON.parse(localStorage.getItem(savedInvoicesKey)) || [];
            const invToLoad = invoices.find(i => i.invoiceNumber === invNum);
            if (invToLoad) {
                if (invToLoad.companyDetails) {
                    companyFields.forEach(id => { const input = el(id); if (input && invToLoad.companyDetails[id] !== undefined) input.value = invToLoad.companyDetails[id]; });
                    const logo = el('previewLogo');
                    if (logo && invToLoad.companyDetails.companyLogoSrc) logo.src = invToLoad.companyDetails.companyLogoSrc;
                    else if (logo) logo.src = 'https://via.placeholder.com/200x100.png?text=ARC+Tech+Logo';
                }

                el('invoiceNumber').value = invToLoad.invoiceNumber; el('invoiceDate').value = invToLoad.invoiceDate;
                el('dueDate').value = invToLoad.dueDate; el('accountNumber').value = invToLoad.accountNumber;
                el('clientName').value = invToLoad.clientName; el('clientAddress').value = invToLoad.clientAddress;
                el('discountRate').value = invToLoad.discountRate; el('termsConditions').value = invToLoad.termsConditions;

                const itemsCont = el('invoiceItemsContainer'); itemsCont.innerHTML = ''; itemCounter = 0;
                invToLoad.items.forEach(item => addInvoiceItem(item.description, item.quantity, item.price));
                updateAllPreviews();
                alert(`تم تحميل الفاتورة رقم: ${invNum}`);
            }
        }

        function deleteSelectedInvoice() {
            const select = el('savedInvoicesList'); const invNum = select.value;
            if (!invNum) { alert('يرجى اختيار فاتورة لحذفها.'); return; }
            if (confirm(`هل أنت متأكد من حذف الفاتورة رقم ${invNum}؟`)) {
                let invoices = JSON.parse(localStorage.getItem(savedInvoicesKey)) || [];
                invoices = invoices.filter(i => i.invoiceNumber !== invNum);
                localStorage.setItem(savedInvoicesKey, JSON.stringify(invoices));
                populateSavedInvoicesList();
                clearInvoiceFormAndPreview(false);
                alert(`تم حذف الفاتورة رقم: ${invNum}`);
            }
        }

        function clearInvoiceFormAndPreview(showAlert = true) {
            const formElements = document.querySelector('.invoice-form').elements;
            for (let i = 0; i < formElements.length; i++) {
                const field = formElements[i];
                if (field.type === 'text' || field.type === 'number' || field.type === 'email' || field.type === 'date' || field.tagName.toLowerCase() === 'textarea') {
                    if (field.id === 'discountRate') field.value = '0';
                    else field.value = '';
                } else if (field.type === 'file') { field.value = null; }
                else if (field.tagName.toLowerCase() === 'select' && field.id !== 'savedInvoicesList' && field.id !== 'currency') { field.selectedIndex = 0;}
            }
            if(el('invoiceDate')) el('invoiceDate').value = getCurrentDate();
            if(el('dueDate')) el('dueDate').value = getCurrentDate();
            if(el('invoiceNumber')) el('invoiceNumber').value = `INV-${String(new Date().getTime()).slice(-4)}`;
            el('invoiceItemsContainer').innerHTML = ''; itemCounter = 0; addInvoiceItem('', 1, 0.00);
            const logo = el('previewLogo'); if (logo) logo.src = 'https://via.placeholder.com/200x100.png?text=ARC+Tech+Logo';
            loadCompanyData(); updateAllPreviews();
            if(el('savedInvoicesList')) el('savedInvoicesList').value = "";
            if (showAlert) alert('تم تجهيز فاتورة جديدة.');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf; const invElem = el('invoiceToPrint'); if (!invElem) return;
            const imageScale = 1.8; const useJPEG = false; const jpegQuality = 0.75;
            const form = document.querySelector('.invoice-form'); const actions = document.querySelector('.actions-buttons-container');
            const origFormDisp = form ? form.style.display : ''; const origActDisp = actions ? actions.style.display : '';
            if (form) form.style.display = 'none'; if (actions) actions.style.display = 'none';
            
            // ضمان أن كامل ارتفاع الفاتورة يؤخذ في الاعتبار
            const scrollY = window.scrollY; // حفظ موضع التمرير الحالي
            window.scrollTo(0,0); // التمرير للأعلى لضمان أن html2canvas يرى بداية الصفحة

            html2canvas(invElem, {
                scale: imageScale, useCORS: true, logging: false,
                width: invElem.offsetWidth, // العرض الفعلي للعنصر
                height: invElem.scrollHeight, // الارتفاع الكلي للعنصر بما في ذلك الجزء غير المرئي بسبب التمرير
                windowWidth: document.documentElement.scrollWidth, // عرض النافذة الكلي
                windowHeight: document.documentElement.scrollHeight, // ارتفاع النافذة الكلي
                scrollY: -window.scrollY // تعويض التمرير لضمان التقاط الجزء العلوي
            }).then(canvas => {
                window.scrollTo(0, scrollY); // إعادة موضع التمرير الأصلي

                let imgData, imgType;
                if (useJPEG) { imgData = canvas.toDataURL('image/jpeg', jpegQuality); imgType = 'JPEG'; }
                else { imgData = canvas.toDataURL('image/png', 1.0); imgType = 'PNG'; }
                const pdf = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
                const pdfW = pdf.internal.pageSize.getWidth(); const pdfH = pdf.internal.pageSize.getHeight();
                const cAR = canvas.width / canvas.height; let imgW = pdfW; let imgH = pdfW / cAR;
                if (imgH > pdfH) { imgH = pdfH; imgW = pdfH * cAR; }
                const x = (pdfW - imgW) / 2; const y = 0;
                pdf.addImage(imgData, imgType, x, y, imgW, imgH, undefined, 'FAST'); // FAST لضغط أفضل
                const invNum = el('previewInvoiceNumber').textContent.trim().replace(/[^\w\s-]/gi, '').replace(/\s+/g, '_') || 'invoice';
                pdf.save(`${invNum}.pdf`);
                if (form) form.style.display = origFormDisp; if (actions) actions.style.display = origActDisp;
            }).catch(err => {
                window.scrollTo(0, scrollY); // إعادة موضع التمرير الأصلي في حالة الخطأ أيضًا
                console.error("PDF Error:", err);
                if (form) form.style.display = origFormDisp; if (actions) actions.style.display = origActDisp;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            if(el('invoiceDate')) el('invoiceDate').value = getCurrentDate();
            if(el('dueDate')) el('dueDate').value = getCurrentDate();
            if(el('invoiceNumber')) el('invoiceNumber').value = `INV-${String(new Date().getTime()).slice(-4)}`;
            if(!el('invoiceItemsContainer').children.length){ addInvoiceItem('', 1, 0.00); }
            loadCompanyData();
            populateSavedInvoicesList();
            updateAllPreviews();
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>نظام فواتير ARC تيك</title>
    <style>
        :root {
            --primary-color: #1A6D69; --secondary-color: #155A56; --light-gray: #f4f6f6;
            --medium-gray: #e9ecef; --dark-gray: #333333; --border-color: #dce3e2;
            --white: #ffffff; --text-color: #4a4a4a;
        }
        body { font-family: 'Tahoma','Arial',sans-serif; margin:0; padding:10px; /* Reduced padding for mobile */ background-color:var(--medium-gray); color:var(--text-color); direction:rtl; font-size:14px; /* Base font for mobile */ -webkit-text-size-adjust: 100%; /* Prevent iOS font scaling */ }
        .container { display:flex; flex-direction:column; gap:20px; max-width:900px; margin:auto; }
        .invoice-form { background-color:var(--white); padding:15px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
        .invoice-form h2, .invoice-form h3 { color:var(--primary-color); border-bottom:1px solid var(--border-color); padding-bottom:8px; margin-top:0; margin-bottom:12px; }
        .invoice-form h2 { font-size:1.3em; } /* Adjusted for mobile */
        .invoice-form h3 { font-size:1.1em; margin-top:15px; } /* Adjusted for mobile */
        .form-group { margin-bottom:10px; }
        .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px 8px; border:1px solid var(--border-color); border-radius:4px; font-size:0.9em; box-sizing:border-box; background-color:#fdfdfd; }
        .form-group textarea { min-height:60px; }
        .form-group ::placeholder { color:#888; opacity:1; font-size:0.9em; }
        .company-data-actions button, .saved-invoices-section button { padding:8px 10px; font-size:0.8em; margin-left:5px;}
        .saved-invoices-section select { margin-bottom: 5px; }

        .item-row { display:flex; flex-wrap: wrap; /* Allow wrapping on small screens */ gap:5px; margin-bottom:8px; align-items:center; }
        .item-row input.item-desc { flex-basis: 100%; margin-bottom: 5px; /* Full width on its own line */ }
        .item-row input.item-qty { width:60px !important; flex-grow:1; text-align:center; }
        .item-row input.item-price { width:80px !important; flex-grow:1; text-align:center; }
        .item-row button.remove-item-btn { padding:8px 10px; font-size:0.85em; flex-shrink: 0; /* Prevent shrinking */ }
        #addItemBtn { padding:9px 12px; font-size:0.95em; display: block; width: 100%; margin-top:10px; }

        .invoice-preview-container { background-color:var(--white); box-shadow:0 3px 10px rgba(0,0,0,0.1); width:100%; max-width:794px; margin:0 auto; padding:0; border:1px solid #ccc; }
        .invoice-preview { padding:20px 15px; /* Reduced padding for mobile */ }
        .invoice-preview-header { display:flex; flex-direction: column-reverse; /* Stack company above invoice details on mobile */ align-items:center; /* Center align header items */ text-align:center; padding-bottom:15px; border-bottom:2px solid var(--primary-color); margin-bottom:15px; }
        .header-left, .header-right { flex-basis:auto; width:100%; } /* Full width for stacked items */
        .header-right { margin-bottom:15px; }
        .header-right img#previewLogo { max-width:150px; max-height:75px; margin:0 auto 10px auto; display:block; } /* Adjusted logo size and centering */
        .header-left h1 { font-size:1.8em; padding:8px 12px; margin-bottom:10px; display:block; }
        .header-left .invoice-meta p { font-size:0.8em; }
        .header-left .invoice-meta strong { display:inline-block; min-width:auto; margin-left:5px; }
        .header-left .bill-to { margin-top:10px; font-size:0.85em;}

        .invoice-items-wrapper { overflow-x:auto; margin-bottom: 15px;}
        .items-table-visual { width:100%; min-width: 550px; /* Ensure table scrolls if content is wide */ border-collapse:collapse; font-size:0.8em; }
        .items-table-visual th, .items-table-visual td { padding:6px 8px; }
        /* ... (rest of table styles as before) ... */
        .items-table-visual th.col-no, .items-table-visual td.col-no {width: 5%;}
        .items-table-visual th.col-desc, .items-table-visual td.col-desc {width: auto; text-align: right;} /* auto for flexibility */
        .items-table-visual th.col-price, .items-table-visual td.col-price {width: 20%;}
        .items-table-visual th.col-qty, .items-table-visual td.col-qty {width: 15%;}
        .items-table-visual th.col-total, .items-table-visual td.col-total {width: 20%;}
        .items-table-visual tbody tr:nth-child(even) td { background-color:var(--light-gray); }


        .invoice-summary-and-terms { display:flex; flex-direction:column; /* Stack on mobile */ margin-bottom:15px; font-size:0.85em; }
        .summary-section { width:100%; text-align:left; margin-bottom:15px; }
        .summary-section table { width:100%; max-width: 320px; /* Limit width on mobile */ margin: 0 auto 10px auto; /* Center summary table */ }
        .summary-section td:first-child { width: auto; padding-left: 5px; } /* Allow label to take needed space */
        .summary-section td:last-child { padding-left: 5px; }
        .summary-section .grand-total-row td { font-size:1em; padding:7px 8px; }
        .summary-section .signature-area { margin-top:20px; width:70%; margin-left:auto; margin-right:auto; }
        .terms-section { width:100%; text-align:center; padding-right:0; } /* Center terms on mobile */
        .terms-section h4 { font-size:0.9em; }
        .terms-section p { font-size:0.8em; }

        .invoice-preview-footer { padding:8px 0; font-size:0.75em; }
        .invoice-preview-footer span { display:block; margin: 3px auto; text-align:center; } /* Stack footer items */

        .actions-buttons-container { padding:10px; margin-top:15px; }
        .actions-buttons-container button { padding:10px 15px; font-size:0.9em; display:block; width:100%; margin:8px 0; }


        /* Larger screens - Tablet and Desktop */
        @media (min-width: 768px) {
            body { padding: 20px; font-size: 15px; }
            .invoice-form { padding: 20px; }
            .invoice-form h2 { font-size:1.5em; }
            .invoice-form h3 { font-size:1.15em; }
            .item-row input.item-desc { flex-basis:auto; margin-bottom: 0; } /* Reset for larger screens */
            .item-row { flex-wrap: nowrap; }
            #addItemBtn { display: inline-block; width: auto; }

            .invoice-preview { padding:30px 35px; }
            .invoice-preview-header { flex-direction:row; align-items:flex-start; text-align:inherit; }
            .header-left { text-align:left; }
            .header-right { text-align:right; }
            .header-right img#previewLogo { max-width:200px; max-height:100px; margin-left:auto; margin-right:0; }
            .header-left h1 { display:inline-block; }
            .header-left .invoice-meta p, .header-left .bill-to { text-align:left; }
            .header-left .invoice-meta strong { min-width:90px; }

            .items-table-visual { min-width: auto; font-size:0.9em; }
            .items-table-visual th, .items-table-visual td { padding:8px 10px; }

            .invoice-summary-and-terms { flex-direction:row; font-size:0.9em; }
            .summary-section { text-align:left; width:45%; }
            .summary-section table { margin: 0 0 15px 0; max-width:none; }
            .summary-section .signature-area { margin-left:0; }
            .terms-section { text-align:right; width:50%; padding-right:20px; }
            .terms-section h4, .terms-section p {text-align: right;}


            .invoice-preview-footer span { display:inline-block; margin: 0 10px; }
            .actions-buttons-container button { display:inline-block; width:auto; margin:5px; }
        }

        @media print {
            body { background-color:var(--white) !important; padding:0; margin:0; font-size:9pt; -webkit-print-color-adjust:exact !important; color-adjust:exact !important; }
            .container, .invoice-form, .actions-buttons-container { display:none !important; }
            .invoice-preview-container { display:block !important; width:100% !important; max-width:none !important; margin:0 !important; padding:0 !important; box-shadow:none !important; border:none !important; }
            .invoice-preview { padding:15mm !important; /* A4-like margins */ page-break-after:always; }
            .invoice-preview-header { flex-direction:row !important; align-items:flex-start !important; text-align:inherit !important; } /* Restore desktop header */
            .invoice-items-wrapper { overflow-x:visible !important; }
            .items-table-visual { min-width:unset !important; font-size: 8.5pt !important; } /* Adjust table font for print */
            .items-table-visual th, .items-table-visual td { padding: 5px 7px !important; }
            .invoice-summary-and-terms { flex-direction:row !important; } /* Restore desktop summary */
        }
    </style>
</head>
<body>
    <!-- ... (نفس محتوى HTML من الإجابة السابقة) ... -->
    <div class="container">
        <div class="invoice-form">
            <h2>إعدادات فاتورة ARC تيك</h2>

            <div class="saved-invoices-section form-group">
                <h3>الفواتير المحفوظة</h3>
                <select id="savedInvoicesList" onchange="loadSelectedInvoice()">
                    <option value="">-- اختر فاتورة للتعديل --</option>
                </select>
                <button type="button" class="delete-btn" onclick="deleteSelectedInvoice()">حذف المختارة</button>
                <button type="button" onclick="clearInvoiceFormAndPreview()" style="margin-right: 5px;">فاتورة جديدة</button>
            </div>
            <hr>

            <div class="form-group">
                <select id="currency" onchange="updateAllPreviews()">
                    <option value="USD" data-symbol="$" selected>دولار أمريكي ($)</option>
                    <option value="SAR" data-symbol="ر.س">ريال سعودي (ر.س)</option>
                    <option value="YER" data-symbol="ر.ي">ريال يمني (ر.ي)</option>
                </select>
            </div>

            <h3>
                معلومات شركتك
                <span class="company-data-actions">
                    <button type="button" onclick="saveCompanyData()">حفظ بيانات الشركة</button>
                    <button type="button" onclick="loadCompanyData()">استرجاع بيانات الشركة</button>
                </span>
            </h3>
            <div class="form-group"><input type="file" id="companyLogo" accept="image/*" onchange="previewLogoImage(event)"></div>
            <div class="form-group"><input type="text" id="brandName" placeholder="اسم الشركة" onkeyup="updatePreview('brandName', 'previewBrandName')"></div>
            <div class="form-group"><input type="text" id="tagline" placeholder="وصف الشركة (اختياري)" onkeyup="updatePreview('tagline', 'previewTagline')"></div>
            <div class="form-group"><input type="text" id="companyPaymentInfo1" placeholder="معلومة دفع 1 (مثال: Account)" onkeyup="updatePreview('companyPaymentInfo1', 'previewCompanyPaymentInfo1')"></div>
            <div class="form-group"><input type="text" id="companyPaymentInfo2" placeholder="معلومة دفع 2 (مثال: A/c Name)" onkeyup="updatePreview('companyPaymentInfo2', 'previewCompanyPaymentInfo2')"></div>
            <div class="form-group"><input type="text" id="companyFooterText" placeholder="نص الفوتر (مثال: بريد، هاتف، موقع)" onkeyup="updatePreview('companyFooterText', 'previewCompanyFooterText')"></div>

            <h3>تفاصيل الفاتورة</h3>
            <div class="form-group"><input type="text" id="invoiceNumber" placeholder="رقم الفاتورة" onkeyup="updatePreview('invoiceNumber', 'previewInvoiceNumber')"></div>
            <div class="form-group"><input type="date" id="invoiceDate" placeholder="تاريخ الفاتورة" onchange="updatePreviewDate('invoiceDate', 'previewInvoiceDate')"></div>
            <div class="form-group"><input type="date" id="dueDate" placeholder="تاريخ الاستحقاق" onchange="updatePreviewDate('dueDate', 'previewDueDate')"></div>
            <div class="form-group"><input type="text" id="accountNumber" placeholder="رقم حساب العميل (إن وجد)" onkeyup="updatePreview('accountNumber', 'previewAccountNumber')"></div>

            <h3>فاتورة إلى (Bill To)</h3>
            <div class="form-group"><input type="text" id="clientName" placeholder="اسم العميل/الشركة" onkeyup="updatePreview('clientName', 'previewClientName')"></div>
            <div class="form-group"><textarea id="clientAddress" placeholder="عنوان العميل" onkeyup="updatePreview('clientAddress', 'previewClientAddress', true)"></textarea></div>

            <h3>بنود الفاتورة</h3>
            <div id="invoiceItemsContainer"></div>
            <button type="button" id="addItemBtn" onclick="addInvoiceItem()">إضافة بند +</button>

            <h3>الملخص</h3>
            <div class="form-group"><input type="number" id="discountRate" placeholder="نسبة الخصم (%)" value="0" min="0" max="100" step="0.01" oninput="calculateTotals()"></div>

            <h3>نصوص إضافية</h3>
            <div class="form-group"><textarea id="termsConditions" placeholder="الشروط والأحكام" onkeyup="updatePreview('termsConditions', 'previewTermsConditions', true)">شكراً لتعاملكم معنا.</textarea></div>
        </div>

        <div class="invoice-preview-container">
            <div class="invoice-preview" id="invoiceToPrint">
                <header class="invoice-preview-header">
                    <div class="header-left">
                        <h1>INVOICE</h1>
                        <div class="invoice-meta">
                            <p><strong>Invoice No:</strong> <span id="previewInvoiceNumber"></span></p>
                            <p><strong>Date:</strong> <span id="previewInvoiceDate"></span></p>
                            <p><strong>Due Date:</strong> <span id="previewDueDate"></span></p>
                            <p><strong>Account No:</strong> <span id="previewAccountNumber"></span></p>
                        </div>
                        <div class="bill-to">
                            <strong>BILL TO.</strong>
                            <span id="previewClientName"></span>
                            <span id="previewClientAddress"></span>
                        </div>
                    </div>
                    <div class="header-right">
                        <img src="https://via.placeholder.com/200x100.png?text=ARC+Tech+Logo" alt="شعار الشركة" id="previewLogo">
                        <div id="previewBrandName">ARC تيك</div>
                        <div id="previewTagline">حلول تقنية متكاملة</div>
                        <div class="payment-info-basic">
                            <p><strong>Account:</strong> <span id="previewCompanyPaymentInfo1"></span></p>
                            <p><strong>A/c Name:</strong> <span id="previewCompanyPaymentInfo2"></span></p>
                        </div>
                    </div>
                </header>
                <div class="invoice-items-wrapper">
                    <table class="items-table-visual">
                        <thead>
                            <tr><th class="col-no">NO</th><th class="col-desc">PRODUCT DESCRIPTION</th><th class="col-price">UNIT PRICE</th><th class="col-qty">QTY</th><th class="col-total">TOTAL</th></tr>
                        </thead>
                        <tbody id="previewItemsTableBody"></tbody>
                    </table>
                </div>
                <section class="invoice-summary-and-terms">
                    <div class="summary-section">
                        <table>
                            <tr><td>المجموع الفرعي</td><td><span id="previewSubtotal"></span></td></tr>
                            <tr id="previewDiscountRow" style="display:none;"><td>الخصم (<span id="previewDiscountRate">0</span>%)</td><td><span id="previewDiscountAmount"></span></td></tr>
                            <tr class="grand-total-row"><td>الإجمالي الكلي</td><td><span id="previewGrandTotal"></span></td></tr>
                        </table>
                        <div class="signature-area">التوقيع</div>
                    </div>
                    <div class="terms-section">
                        <h4>الشروط والأحكام</h4>
                        <p id="previewTermsConditions"></p>
                    </div>
                </section>
                <footer class="invoice-preview-footer"><span id="previewCompanyFooterText"></span></footer>
            </div>
        </div>
        <div class="actions-buttons-container">
            <button onclick="saveCurrentInvoice()">حفظ/تحديث الفاتورة</button>
            <button onclick="window.print()">طباعة الفاتورة</button>
            <button class="pdf-btn" onclick="downloadPDF()">تنزيل كـ PDF</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // --- JavaScript (نفس الكود من الإجابة السابقة) ---
        // ... (انسخ والصق كامل كود JavaScript من الإجابة السابقة هنا) ...
        // يتضمن: itemCounter, currentCurrencySymbol, companyDataKey, savedInvoicesKey, companyFields
        // والدوال: el, getCurrentDate, getCurrentDisplayDate, updatePreview, updatePreviewDate,
        // previewLogoImage, addInvoiceItem, removeInvoiceItem, formatCurrency, calculateTotals,
        // updateAllPreviews, saveCompanyData, loadCompanyData, saveCurrentInvoice,
        // populateSavedInvoicesList, loadSelectedInvoice, deleteSelectedInvoice,
        // clearInvoiceFormAndPreview, downloadPDF (المعدلة), و event listener لـ DOMContentLoaded
        let itemCounter = 0;
        let currentCurrencySymbol = '$';
        const companyDataKey = 'arcTechCompanyData_v1';
        const savedInvoicesKey = 'arcTechSavedInvoices_v1';
        const companyFields = ['brandName', 'tagline', 'companyPaymentInfo1', 'companyPaymentInfo2', 'companyFooterText'];

        function el(id) { return document.getElementById(id); }

        function getCurrentDate() { const n = new Date(); return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`; }
        function getCurrentDisplayDate() { const n = new Date(); return `${String(n.getDate()).padStart(2,'0')}/${String(n.getMonth()+1).padStart(2,'0')}/${n.getFullYear()}`; }

        function updatePreview(inputId, previewId, isTextarea = false) {
            const input = el(inputId); const preview = el(previewId);
            if (input && preview) preview[isTextarea ? 'innerText' : 'textContent'] = input.value;
        }

        function updatePreviewDate(inputId, previewId) {
            const input = el(inputId); const preview = el(previewId);
            if (input && preview) {
                const dateVal = input.value;
                if (dateVal) { const [y,m,d] = dateVal.split('-'); preview.textContent = `${d}/${m}/${y}`; }
                else { preview.textContent = (inputId === 'invoiceDate') ? getCurrentDisplayDate() : ''; }
            }
        }

        function previewLogoImage(event) {
            const reader = new FileReader(); const output = el('previewLogo'); if (!output) return;
            reader.onload = function(){ output.src = reader.result; };
            if (event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
            else output.src = 'https://via.placeholder.com/200x100.png?text=ARC+Tech+Logo';
        }

        function addInvoiceItem(description = '', quantity = 1, price = 0.00) {
            itemCounter++;
            const container = el('invoiceItemsContainer'); if (!container) return;
            const row = document.createElement('div'); row.className = 'item-row'; row.id = `item-row-${itemCounter}`;
            row.innerHTML = `
                <input type="text" class="item-desc" placeholder="وصف البند" value="${description}" oninput="calculateTotals()">
                <input type="number" class="item-qty" value="${quantity}" min="0" placeholder="الكمية" oninput="calculateTotals()">
                <input type="number" class="item-price" value="${parseFloat(price).toFixed(2)}" step="0.01" placeholder="السعر" oninput="calculateTotals()">
                <button type="button" class="remove-item-btn" onclick="removeInvoiceItem('item-row-${itemCounter}')">X</button>`;
            container.appendChild(row);
            calculateTotals();
        }

        function removeInvoiceItem(rowId) { const row = el(rowId); if (row) row.remove(); calculateTotals(); }
        function formatCurrency(amount) { return `${currentCurrencySymbol} ${parseFloat(amount).toFixed(2)}`; }

        function calculateTotals() {
            const itemsCont = el('invoiceItemsContainer'); const tableBody = el('previewItemsTableBody');
            if (!itemsCont || !tableBody) return;
            tableBody.innerHTML = ''; let subtotal = 0; let num = 0;

            Array.from(itemsCont.children).forEach(r => {
                if (!r.classList.contains('item-row')) return; num++;
                const desc = r.querySelector('.item-desc').value;
                const qty = parseFloat(r.querySelector('.item-qty').value) || 0;
                const price = parseFloat(r.querySelector('.item-price').value) || 0;
                const total = qty * price; subtotal += total;
                const pR = tableBody.insertRow();
                pR.insertCell().outerHTML=`<td class="col-no">${String(num).padStart(2,'0')}</td>`;
                pR.insertCell().outerHTML=`<td class="col-desc">${desc}</td>`;
                pR.insertCell().outerHTML=`<td class="col-price">${formatCurrency(price)}</td>`;
                pR.insertCell().outerHTML=`<td class="col-qty">${qty}</td>`;
                pR.insertCell().outerHTML=`<td class="col-total">${formatCurrency(total)}</td>`;
            });

            const discInput = el('discountRate'); const discPerc = discInput ? parseFloat(discInput.value) || 0 : 0;
            const discAmount = (subtotal * discPerc) / 100;
            const grandTotal = subtotal - discAmount;

            if(el('previewSubtotal')) el('previewSubtotal').textContent = formatCurrency(subtotal);
            if(el('previewDiscountRate')) el('previewDiscountRate').textContent = discPerc;
            if(el('previewDiscountAmount')) el('previewDiscountAmount').textContent = formatCurrency(discAmount);
            if(el('previewGrandTotal')) el('previewGrandTotal').textContent = formatCurrency(grandTotal);
            const discRow = el('previewDiscountRow'); if(discRow) discRow.style.display = discPerc > 0 ? 'table-row' : 'none';
        }

        function updateAllPreviews() {
            const currSelect = el('currency'); if (currSelect) currentCurrencySymbol = currSelect.options[currSelect.selectedIndex].dataset.symbol;
            companyFields.forEach(id => updatePreview(id, `preview${id.charAt(0).toUpperCase() + id.slice(1)}`));
            updatePreview('invoiceNumber', 'previewInvoiceNumber'); updatePreviewDate('invoiceDate', 'previewInvoiceDate');
            updatePreviewDate('dueDate', 'previewDueDate'); updatePreview('accountNumber', 'previewAccountNumber');
            updatePreview('clientName', 'previewClientName'); updatePreview('clientAddress', 'previewClientAddress', true);
            updatePreview('termsConditions', 'previewTermsConditions', true);
            calculateTotals();
        }

        function saveCompanyData() {
            const data = {}; companyFields.forEach(id => { const input = el(id); if (input) data[id] = input.value; });
            const logo = el('previewLogo');
            if (logo && logo.src && !logo.src.includes('via.placeholder.com')) data.companyLogoSrc = logo.src; else data.companyLogoSrc = '';
            localStorage.setItem(companyDataKey, JSON.stringify(data)); alert('تم حفظ بيانات الشركة!');
        }

        function loadCompanyData() {
            const saved = localStorage.getItem(companyDataKey);
            if (saved) {
                const data = JSON.parse(saved);
                companyFields.forEach(id => { const input = el(id); if (input && data[id] !== undefined) input.value = data[id]; });
                const logo = el('previewLogo');
                if (logo && data.companyLogoSrc) logo.src = data.companyLogoSrc;
                else if (logo) logo.src = 'https://via.placeholder.com/200x100.png?text=ARC+Tech+Logo';
            }
        }

        function saveCurrentInvoice() {
            const invNum = el('invoiceNumber').value.trim(); if (!invNum) { alert('يرجى إدخال رقم الفاتورة.'); return; }
            const invData = {
                invoiceNumber: invNum, invoiceDate: el('invoiceDate').value, dueDate: el('dueDate').value,
                accountNumber: el('accountNumber').value, clientName: el('clientName').value, clientAddress: el('clientAddress').value,
                discountRate: el('discountRate').value, termsConditions: el('termsConditions').value,
                companyDetails: {}, items: []
            };
            companyFields.forEach(id => { const input = el(id); if (input) invData.companyDetails[id] = input.value; });
            const logo = el('previewLogo');
            if (logo && logo.src && !logo.src.includes('via.placeholder.com')) invData.companyDetails.companyLogoSrc = logo.src;
            else invData.companyDetails.companyLogoSrc = '';

            const itemsCont = el('invoiceItemsContainer');
            Array.from(itemsCont.children).forEach(r => {
                if (r.classList.contains('item-row')) {
                    invData.items.push({
                        description: r.querySelector('.item-desc').value,
                        quantity: r.querySelector('.item-qty').value,
                        price: r.querySelector('.item-price').value
                    });
                }
            });

            let invoices = JSON.parse(localStorage.getItem(savedInvoicesKey)) || [];
            const idx = invoices.findIndex(i => i.invoiceNumber === invNum);
            if (idx > -1) invoices[idx] = invData; else invoices.push(invData);
            localStorage.setItem(savedInvoicesKey, JSON.stringify(invoices));
            alert(idx > -1 ? 'تم تحديث الفاتورة!' : 'تم حفظ الفاتورة!');
            populateSavedInvoicesList();
        }

        function populateSavedInvoicesList() {
            const select = el('savedInvoicesList'); select.innerHTML = '<option value="">-- اختر فاتورة للتعديل --</option>';
            const invoices = JSON.parse(localStorage.getItem(savedInvoicesKey)) || [];
            invoices.sort((a, b) => (a.invoiceNumber > b.invoiceNumber) ? 1 : -1);
            invoices.forEach(inv => {
                const opt = document.createElement('option');
                opt.value = inv.invoiceNumber;
                opt.textContent = `فاتورة: ${inv.invoiceNumber} (عميل: ${inv.clientName || 'N/A'})`;
                select.appendChild(opt);
            });
        }

        function loadSelectedInvoice() {
            const select = el('savedInvoicesList'); const invNum = select.value;
            if (!invNum) { clearInvoiceFormAndPreview(false); return; }
            const invoices = JSON.parse(localStorage.getItem(savedInvoicesKey)) || [];
            const invToLoad = invoices.find(i => i.invoiceNumber === invNum);
            if (invToLoad) {
                if (invToLoad.companyDetails) {
                    companyFields.forEach(id => { const input = el(id); if (input && invToLoad.companyDetails[id] !== undefined) input.value = invToLoad.companyDetails[id]; });
                    const logo = el('previewLogo');
                    if (logo && invToLoad.companyDetails.companyLogoSrc) logo.src = invToLoad.companyDetails.companyLogoSrc;
                    else if (logo) logo.src = 'https://via.placeholder.com/200x100.png?text=ARC+Tech+Logo';
                }

                el('invoiceNumber').value = invToLoad.invoiceNumber; el('invoiceDate').value = invToLoad.invoiceDate;
                el('dueDate').value = invToLoad.dueDate; el('accountNumber').value = invToLoad.accountNumber;
                el('clientName').value = invToLoad.clientName; el('clientAddress').value = invToLoad.clientAddress;
                el('discountRate').value = invToLoad.discountRate; el('termsConditions').value = invToLoad.termsConditions;

                const itemsCont = el('invoiceItemsContainer'); itemsCont.innerHTML = ''; itemCounter = 0;
                invToLoad.items.forEach(item => addInvoiceItem(item.description, item.quantity, item.price));
                updateAllPreviews();
                alert(`تم تحميل الفاتورة رقم: ${invNum}`);
            }
        }

        function deleteSelectedInvoice() {
            const select = el('savedInvoicesList'); const invNum = select.value;
            if (!invNum) { alert('يرجى اختيار فاتورة لحذفها.'); return; }
            if (confirm(`هل أنت متأكد من حذف الفاتورة رقم ${invNum}؟`)) {
                let invoices = JSON.parse(localStorage.getItem(savedInvoicesKey)) || [];
                invoices = invoices.filter(i => i.invoiceNumber !== invNum);
                localStorage.setItem(savedInvoicesKey, JSON.stringify(invoices));
                populateSavedInvoicesList();
                clearInvoiceFormAndPreview(false);
                alert(`تم حذف الفاتورة رقم: ${invNum}`);
            }
        }

        function clearInvoiceFormAndPreview(showAlert = true) {
            const formElements = document.querySelector('.invoice-form').elements;
            for (let i = 0; i < formElements.length; i++) {
                const field = formElements[i];
                if (field.type === 'text' || field.type === 'number' || field.type === 'email' || field.type === 'date' || field.tagName.toLowerCase() === 'textarea') {
                    if (field.id === 'discountRate') field.value = '0';
                    else field.value = '';
                } else if (field.type === 'file') { field.value = null; }
                else if (field.tagName.toLowerCase() === 'select' && field.id !== 'savedInvoicesList' && field.id !== 'currency') { field.selectedIndex = 0;}
            }
            if(el('invoiceDate')) el('invoiceDate').value = getCurrentDate();
            if(el('dueDate')) el('dueDate').value = getCurrentDate();
            if(el('invoiceNumber')) el('invoiceNumber').value = `INV-${String(new Date().getTime()).slice(-4)}`;
            el('invoiceItemsContainer').innerHTML = ''; itemCounter = 0; addInvoiceItem('', 1, 0.00);
            const logo = el('previewLogo'); if (logo) logo.src = 'https://via.placeholder.com/200x100.png?text=ARC+Tech+Logo';
            loadCompanyData(); updateAllPreviews();
            if(el('savedInvoicesList')) el('savedInvoicesList').value = "";
            if (showAlert) alert('تم تجهيز فاتورة جديدة.');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf; const invElem = el('invoiceToPrint'); if (!invElem) return;
            const imageScale = 1.8; const useJPEG = false; const jpegQuality = 0.75;
            const form = document.querySelector('.invoice-form'); const actions = document.querySelector('.actions-buttons-container');
            const origFormDisp = form ? form.style.display : ''; const origActDisp = actions ? actions.style.display : '';
            if (form) form.style.display = 'none'; if (actions) actions.style.display = 'none';
            
            // ضمان أن كامل ارتفاع الفاتورة يؤخذ في الاعتبار
            const scrollY = window.scrollY; // حفظ موضع التمرير الحالي
            window.scrollTo(0,0); // التمرير للأعلى لضمان أن html2canvas يرى بداية الصفحة

            html2canvas(invElem, {
                scale: imageScale, useCORS: true, logging: false,
                width: invElem.offsetWidth, // العرض الفعلي للعنصر
                height: invElem.scrollHeight, // الارتفاع الكلي للعنصر بما في ذلك الجزء غير المرئي بسبب التمرير
                windowWidth: document.documentElement.scrollWidth, // عرض النافذة الكلي
                windowHeight: document.documentElement.scrollHeight, // ارتفاع النافذة الكلي
                scrollY: -window.scrollY // تعويض التمرير لضمان التقاط الجزء العلوي
            }).then(canvas => {
                window.scrollTo(0, scrollY); // إعادة موضع التمرير الأصلي

                let imgData, imgType;
                if (useJPEG) { imgData = canvas.toDataURL('image/jpeg', jpegQuality); imgType = 'JPEG'; }
                else { imgData = canvas.toDataURL('image/png', 1.0); imgType = 'PNG'; }
                const pdf = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
                const pdfW = pdf.internal.pageSize.getWidth(); const pdfH = pdf.internal.pageSize.getHeight();
                const cAR = canvas.width / canvas.height; let imgW = pdfW; let imgH = pdfW / cAR;
                if (imgH > pdfH) { imgH = pdfH; imgW = pdfH * cAR; }
                const x = (pdfW - imgW) / 2; const y = 0;
                pdf.addImage(imgData, imgType, x, y, imgW, imgH, undefined, 'FAST'); // FAST لضغط أفضل
                const invNum = el('previewInvoiceNumber').textContent.trim().replace(/[^\w\s-]/gi, '').replace(/\s+/g, '_') || 'invoice';
                pdf.save(`${invNum}.pdf`);
                if (form) form.style.display = origFormDisp; if (actions) actions.style.display = origActDisp;
            }).catch(err => {
                window.scrollTo(0, scrollY); // إعادة موضع التمرير الأصلي في حالة الخطأ أيضًا
                console.error("PDF Error:", err);
                if (form) form.style.display = origFormDisp; if (actions) actions.style.display = origActDisp;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            if(el('invoiceDate')) el('invoiceDate').value = getCurrentDate();
            if(el('dueDate')) el('dueDate').value = getCurrentDate();
            if(el('invoiceNumber')) el('invoiceNumber').value = `INV-${String(new Date().getTime()).slice(-4)}`;
            if(!el('invoiceItemsContainer').children.length){ addInvoiceItem('', 1, 0.00); }
            loadCompanyData();
            populateSavedInvoicesList();
            updateAllPreviews();
        });
    </script>
</body>
</html>
